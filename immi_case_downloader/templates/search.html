{% extends "base.html" %}
{% block title %}Search Cases{% endblock %}

{% block content %}
<nav aria-label="breadcrumb"><ol class="breadcrumb small">
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item active">Search for New Cases</li>
</ol></nav>
<div class="d-flex justify-content-between align-items-center mb-3">
  <div><h4 class="mb-0 font-serif">Search for New Cases</h4><small class="text-muted">Find immigration, home affairs, and refugee cases from Australian courts &amp; tribunals</small></div>
</div>

<form method="post" id="searchForm">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="row g-3">
    <div class="col-lg-8">
      <!-- AustLII database cards -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-bank me-1"></i>AustLII Databases</span>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary py-0 px-2" onclick="toggleAll(true)">Select All</button>
            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="toggleAll(false)">Clear</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Quick presets -->
          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="small text-muted me-1" style="line-height:1.8;">Presets:</span>
            <button type="button" class="btn btn-sm btn-outline-accent py-0 px-2" onclick="applyPreset('active')">All Active Courts</button>
            <button type="button" class="btn btn-sm btn-outline-accent py-0 px-2" onclick="applyPreset('recent')">2024&ndash;2026 Only</button>
            <button type="button" class="btn btn-sm btn-outline-accent py-0 px-2" onclick="applyPreset('fca')">Federal Court Only</button>
          </div>

          <!-- Active databases -->
          <div class="row g-2">
            {% for code, info in databases.items() %}
              {% if code not in ('RRTA', 'MRTA') %}
              <div class="col-md-6 col-lg-4">
                <label class="source-card d-flex align-items-start gap-2 w-100 {% if code in ('ARTA', 'FCA', 'FCCA', 'FedCFamC2G') %}selected{% endif %}{% if code == 'AATA' %} source-card-defunct{% endif %}" for="db_{{ code }}" id="label_db_{{ code }}">
                  <div class="check-icon mt-1"><i class="bi bi-check-lg" style="font-size:.7rem;"></i></div>
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-1">
                      <span class="badge badge-court badge-{{ code }}">{{ code }}</span>
                      {% if code == 'AATA' %}
                        <span class="badge bg-warning text-dark" style="font-size:.55rem;">Ended Oct 2024</span>
                      {% endif %}
                      {% if code == 'ARTA' %}
                        <span class="badge bg-success" style="font-size:.55rem;">New</span>
                      {% endif %}
                    </div>
                    <div class="source-name mt-1">{{ info.name }}</div>
                    <div class="source-desc">{{ info.description }}</div>
                  </div>
                  <input type="checkbox" name="databases" value="{{ code }}" id="db_{{ code }}"
                    {% if code in ('ARTA', 'FCA', 'FCCA', 'FedCFamC2G') %}checked{% endif %}
                    onchange="this.closest('.source-card').classList.toggle('selected', this.checked)">
                </label>
              </div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Legacy/defunct tribunals (collapsed) -->
          <details class="mt-3">
            <summary class="small text-muted" style="cursor:pointer;">
              <i class="bi bi-archive me-1"></i>Legacy Tribunals (pre-2015, 0 results)
            </summary>
            <div class="row g-2 mt-1">
              {% for code in ('RRTA', 'MRTA') %}
                {% if code in databases %}
                <div class="col-md-6 col-lg-4">
                  <label class="source-card source-card-defunct d-flex align-items-start gap-2 w-100" for="db_{{ code }}" id="label_db_{{ code }}">
                    <div class="check-icon mt-1"><i class="bi bi-check-lg" style="font-size:.7rem;"></i></div>
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center gap-1">
                        <span class="badge badge-court badge-{{ code }}">{{ code }}</span>
                        <span class="badge bg-secondary" style="font-size:.55rem;">Defunct</span>
                      </div>
                      <div class="source-name mt-1">{{ databases[code].name }}</div>
                      <div class="source-desc">{{ databases[code].description }}</div>
                    </div>
                    <input type="checkbox" name="databases" value="{{ code }}" id="db_{{ code }}"
                      onchange="this.closest('.source-card').classList.toggle('selected', this.checked)">
                  </label>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </details>
        </div>
      </div>

      <!-- Federal Court source (disabled) -->
      <div class="card source-card-unavailable">
        <div class="card-header text-muted">
          <i class="bi bi-globe me-1"></i>Other Sources
          <span class="badge bg-secondary ms-2" style="font-size:.55rem;">Unavailable</span>
        </div>
        <div class="card-body">
          <label class="source-card source-card-defunct d-flex align-items-start gap-2 w-100" for="src_fedcourt" id="label_src_fedcourt">
            <div class="check-icon mt-1"><i class="bi bi-check-lg" style="font-size:.7rem;"></i></div>
            <div class="flex-grow-1">
              <div class="source-code text-muted">Federal Court Judgment Search</div>
              <div class="source-desc">
                <i class="bi bi-exclamation-triangle me-1"></i>search2.fedcourt.gov.au &mdash; DNS does not resolve. Use AustLII FCA database instead.
              </div>
            </div>
            <input type="checkbox" name="sources" value="fedcourt" id="src_fedcourt" disabled
              onchange="this.closest('.source-card').classList.toggle('selected', this.checked)">
          </label>
        </div>
      </div>
    </div>

    <!-- Parameters sidebar -->
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header"><i class="bi bi-sliders me-1"></i>Search Parameters</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label small" for="start_year">Start Year</label>
            <input type="number" name="start_year" id="start_year" class="form-control form-control-sm" value="{{ start_year }}" min="2000" max="2030">
          </div>
          <div class="mb-3">
            <label class="form-label small" for="end_year">End Year</label>
            <input type="number" name="end_year" id="end_year" class="form-control form-control-sm" value="{{ end_year }}" min="2000" max="2030">
          </div>
          <div class="mb-3">
            <label class="form-label small" for="max_results">Max Results per Database</label>
            <select name="max_results" id="max_results" class="form-select form-select-sm">
              <option value="100">100 (quick)</option>
              <option value="250">250</option>
              <option value="500" selected>500 (recommended)</option>
              <option value="1000">1,000</option>
              <option value="5000">5,000 (slow)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary"><i class="bi bi-search me-2"></i>Start Search</button>
      </div>
      <div class="text-center mt-2">
        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Search runs in background. Monitor on <a href="{{ url_for('job_status_page') }}">Job Status</a> page.</small>
      </div>

      <!-- Workflow steps -->
      <div class="card mt-3 border-accent">
        <div class="card-body small">
          <div class="fw-semibold mb-2 font-serif"><i class="bi bi-signpost-split me-1 text-accent"></i>Search Workflow</div>
          <div class="workflow-steps">
            <div class="workflow-step">
              <span class="workflow-num">1</span>
              <span>Select courts &amp; set date range above</span>
            </div>
            <div class="workflow-step">
              <span class="workflow-num">2</span>
              <span>Click <strong>Start Search</strong> &mdash; runs in background</span>
            </div>
            <div class="workflow-step">
              <span class="workflow-num">3</span>
              <span>Results merge with your existing records</span>
            </div>
            <div class="workflow-step">
              <span class="workflow-num">4</span>
              <span>Go to <a href="{{ url_for('download_page') }}"><i class="bi bi-cloud-download me-1"></i>Download Texts</a> to fetch full judgments</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function toggleAll(state) {
  document.querySelectorAll('#searchForm input[name="databases"]:not(:disabled)').forEach(function(cb) {
    cb.checked = state;
    cb.closest('.source-card').classList.toggle('selected', state);
  });
}

function applyPreset(preset) {
  // Clear all first
  toggleAll(false);

  var codes;
  if (preset === 'active') {
    codes = ['ARTA', 'FCA', 'FedCFamC2G', 'HCA'];
  } else if (preset === 'recent') {
    codes = ['ARTA', 'FCA', 'FedCFamC2G', 'HCA'];
    document.getElementById('start_year').value = '2024';
  } else if (preset === 'fca') {
    codes = ['FCA'];
  }

  codes.forEach(function(code) {
    var cb = document.getElementById('db_' + code);
    if (cb) {
      cb.checked = true;
      cb.closest('.source-card').classList.add('selected');
    }
  });
}
</script>
{% endblock %}
