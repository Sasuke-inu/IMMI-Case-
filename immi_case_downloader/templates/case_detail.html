{% extends "base.html" %}
{% block title %}{{ case.citation or case.title[:40] }}{% endblock %}

{% block content %}
<!-- Hero / header -->
<div class="case-hero">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-2 small">
      <li class="breadcrumb-item"><a href="{{ url_for('case_list') }}" class="text-decoration-none">Cases</a></li>
      <li class="breadcrumb-item active">{{ case.citation or case.case_id[:12] }}</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="citation-display">
        {{ case.citation or 'No citation' }}
        {% if case.citation %}
        <button class="copy-btn" data-copy="{{ case.citation|e }}" title="Copy citation" aria-label="Copy citation"><i class="bi bi-clipboard"></i></button>
        {% endif %}
        <span class="badge badge-court badge-{{ case.court_code }} ms-1">{{ case.court_code }}</span>
        {% if case.case_nature %}<span class="badge badge-nature badge-nature-{{ case.case_nature | lower | replace(' ', '-') }} ms-1">{{ case.case_nature }}</span>{% endif %}
        {% if case.outcome %}
          {% set ol = case.outcome.lower() %}
          <span class="badge badge-outcome {% if 'affirm' in ol or 'dismiss' in ol or 'refus' in ol %}affirm{% elif 'set aside' in ol or 'allow' in ol or 'remit' in ol or 'grant' in ol %}setaside{% else %}unknown{% endif %}">
            {% if 'affirm' in ol %}Affirmed{% elif 'dismiss' in ol %}Dismissed{% elif 'set aside' in ol %}Set aside{% elif 'allow' in ol %}Allowed{% elif 'remit' in ol %}Remitted{% elif 'grant' in ol %}Granted{% elif 'refus' in ol %}Refused{% else %}Decided{% endif %}
          </span>
        {% endif %}
      </div>
      <div class="case-title mt-1">{{ case.title }}</div>
    </div>
    <div class="d-flex gap-2 flex-shrink-0">
      {% if case.url %}<a href="{{ case.url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary"><i class="bi bi-box-arrow-up-right me-1"></i>Source</a>{% endif %}
      <a href="{{ url_for('case_edit', case_id=case.case_id) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil me-1"></i>Edit</a>
      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" aria-label="Delete case"><i class="bi bi-trash"></i></button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade delete-modal" id="deleteModal" tabindex="-1" aria-label="Confirm delete">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title font-serif"><i class="bi bi-exclamation-triangle me-2" style="color:var(--immi-danger);"></i>Delete Case</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body small">
        <p>Are you sure you want to permanently delete this case?</p>
        <p class="fw-semibold mb-0">{{ case.citation or case.title[:50] }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('case_delete', case_id=case.case_id) }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash me-1"></i>Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Metadata grid -->
<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">Case Details</div>
      <div class="card-body">
        <div class="meta-grid">
          <div class="meta-item"><div class="meta-label">Case ID</div><div class="meta-value"><code style="font-size:.8em;">{{ case.case_id }}</code></div></div>
          <div class="meta-item"><div class="meta-label">Citation</div><div class="meta-value">{{ case.citation or '—' }}</div></div>
          <div class="meta-item"><div class="meta-label">Court / Tribunal</div><div class="meta-value"><span class="badge badge-court badge-{{ case.court_code }} me-1">{{ case.court_code }}</span>{{ case.court }}</div></div>
          <div class="meta-item"><div class="meta-label">Decision Date</div><div class="meta-value">{{ case.date or 'Unknown' }}</div></div>
          <div class="meta-item"><div class="meta-label">Year</div><div class="meta-value">{{ case.year or 'Unknown' }}</div></div>
          <div class="meta-item"><div class="meta-label">Judge(s) / Member(s)</div><div class="meta-value">{{ case.judges or 'Not extracted' }}</div></div>
          <div class="meta-item"><div class="meta-label">Case Nature</div><div class="meta-value">{% if case.case_nature %}<span class="badge badge-nature badge-nature-{{ case.case_nature | lower | replace(' ', '-') }}">{{ case.case_nature }}</span>{% else %}—{% endif %}</div></div>
          <div class="meta-item"><div class="meta-label">Source</div><div class="meta-value">{{ case.source }}</div></div>
        </div>

        {% if case.outcome %}
        <div class="mt-3 p-2 rounded" style="background:var(--immi-surface);">
          <div class="meta-label mb-1">Outcome / Decision</div>
          <div class="small">{{ case.outcome }}</div>
        </div>
        {% endif %}

        <div class="mt-2 p-2 rounded" style="background:var(--immi-surface);">
          <div class="meta-label mb-1">Visa Information</div>
          <div class="small d-flex flex-wrap gap-3">
            <span><strong>Type:</strong> {{ case.visa_type or '—' }}</span>
            {% if case.visa_subclass %}<span><strong>Subclass:</strong> {{ case.visa_subclass }}</span>{% endif %}
            {% if case.visa_class_code %}<span><strong>Class Code:</strong> {{ case.visa_class_code }}</span>{% endif %}
          </div>
        </div>

        {% if case.legislation %}
        <div class="mt-2 p-2 rounded" style="background:var(--immi-surface);">
          <div class="meta-label mb-1">Legislation</div>
          <div class="small">{{ case.legislation }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Notes & Tags -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        Notes & Tags
        <a href="{{ url_for('case_edit', case_id=case.case_id) }}" class="btn btn-sm btn-outline-secondary py-0 px-1" aria-label="Edit notes"><i class="bi bi-pencil"></i></a>
      </div>
      <div class="card-body">
        {% if case.tags %}
        <div class="mb-2">{% for tag in case.tags.split(',') %}{% set t = tag.strip() %}{% if t %}<a href="{{ url_for('case_list', tag=t) }}" class="badge bg-accent-muted text-accent me-1 text-decoration-none">{{ t }}</a>{% endif %}{% endfor %}</div>
        {% endif %}
        {% if case.user_notes %}
        <div class="small" style="white-space:pre-wrap;">{{ case.user_notes }}</div>
        {% else %}
        <p class="text-muted small mb-0">No notes yet. <a href="{{ url_for('case_edit', case_id=case.case_id) }}">Add notes</a></p>
        {% endif %}
      </div>
    </div>

    <!-- Catchwords -->
    <div class="card mb-3">
      <div class="card-header">Catchwords</div>
      <div class="card-body">
        {% if case.catchwords %}
        <div class="small">{{ case.catchwords }}</div>
        {% else %}
        <p class="text-muted small mb-0">Not extracted. Download full text to populate.</p>
        {% endif %}
      </div>
    </div>

    <!-- Legal Concepts -->
    {% if case.legal_concepts %}
    <div class="card">
      <div class="card-header">Legal Concepts</div>
      <div class="card-body">
        {% for concept in case.legal_concepts.split(';') %}{% set c = concept.strip() %}{% if c %}<a href="{{ url_for('case_list', q=c) }}" class="concept-tag">{{ c }}</a>{% endif %}{% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Related Cases -->
{% if related_cases %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-diagram-3 me-1"></i>Related Cases</span>
    <span class="badge bg-accent-muted text-accent">{{ related_cases|length }}</span>
  </div>
  <div class="card-body p-0">
    <div class="related-cases-grid">
      {% for rc in related_cases %}
      <a href="{{ url_for('case_detail', case_id=rc.case_id) }}" class="related-case-card text-decoration-none">
        <div class="related-case-citation">
          {{ rc.citation or '---' }}
          <span class="badge badge-court badge-{{ rc.court_code }} ms-1">{{ rc.court_code }}</span>
        </div>
        <div class="related-case-title">{{ rc.title }}</div>
        <div class="related-case-meta">
          {% if rc.case_nature %}<span class="badge badge-nature badge-nature-{{ rc.case_nature | lower | replace(' ', '-') }}">{{ rc.case_nature }}</span>{% endif %}
          {% if rc.outcome %}{% set ol = rc.outcome.lower() %}
            <span class="badge badge-outcome {% if 'affirm' in ol or 'dismiss' in ol or 'refus' in ol %}affirm{% elif 'set aside' in ol or 'allow' in ol or 'remit' in ol or 'grant' in ol %}setaside{% else %}unknown{% endif %}">{% if 'affirm' in ol %}Affirmed{% elif 'dismiss' in ol %}Dismissed{% elif 'set aside' in ol %}Set aside{% elif 'allow' in ol %}Allowed{% elif 'remit' in ol %}Remitted{% elif 'grant' in ol %}Granted{% elif 'refus' in ol %}Refused{% else %}Decided{% endif %}</span>
          {% endif %}
          {% if rc.year %}<span class="small text-muted">{{ rc.year }}</span>{% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Full text viewer -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Full Case Text</span>
    {% if full_text %}<span class="badge bg-accent-muted text-accent">{{ full_text | length }} chars</span>{% endif %}
  </div>
  {% if full_text %}
  <div class="case-text-viewer">
    <div class="text-toolbar">
      <i class="bi bi-search" style="font-size:.8rem;"></i>
      <input type="text" id="textSearch" placeholder="Search within case text... (Ctrl+F)" oninput="textSearchHandler.search(this.value)">
      <button class="nav-btn" id="searchPrev" onclick="textSearchHandler.prev()" disabled title="Previous match (Shift+Enter)"><i class="bi bi-chevron-up"></i></button>
      <button class="nav-btn" id="searchNext" onclick="textSearchHandler.next()" disabled title="Next match (Enter)"><i class="bi bi-chevron-down"></i></button>
      <span class="small text-muted" id="searchCount"></span>
      <span class="ms-auto d-flex gap-1">
        <button class="nav-btn" onclick="textSearchHandler.download()" title="Download as .txt"><i class="bi bi-download"></i></button>
        <button class="nav-btn" onclick="window.print()" title="Print"><i class="bi bi-printer"></i></button>
      </span>
    </div>
    <div class="text-content" id="caseTextContent">{{ full_text }}</div>
    <div class="text-expand-toggle" id="textExpandToggle">
      <button onclick="textSearchHandler.toggleExpand()"><i class="bi bi-arrows-expand me-1"></i><span id="expandLabel">Show full text</span></button>
    </div>
  </div>
  {% else %}
  <div class="card-body">
    <div class="empty-state py-4">
      <div class="empty-icon" style="font-size:2rem;"><i class="bi bi-file-earmark-text"></i></div>
      <p class="text-muted">Full text not yet downloaded.</p>
      <a href="{{ url_for('download_page') }}" class="btn btn-outline-primary btn-sm">Download Case Texts</a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Copy button */
document.querySelectorAll('.copy-btn[data-copy]').forEach(function(btn) {
  btn.addEventListener('click', function() {
    navigator.clipboard.writeText(btn.getAttribute('data-copy')).then(function() {
      btn.classList.add('copied');
      var icon = btn.querySelector('i');
      icon.className = 'bi bi-check';
      setTimeout(function() { btn.classList.remove('copied'); icon.className = 'bi bi-clipboard'; }, 2000);
    });
  });
});

/* Enhanced text search with navigation */
var textSearchHandler = (function() {
  var el = document.getElementById('caseTextContent');
  var countEl = document.getElementById('searchCount');
  var prevBtn = document.getElementById('searchPrev');
  var nextBtn = document.getElementById('searchNext');
  var currentIdx = -1;
  var marks = [];

  function getOriginal() {
    if (!el) return '';
    if (!el._original) el._original = el.textContent;
    return el._original;
  }

  function updateNav() {
    var total = marks.length;
    if (total === 0) {
      countEl.textContent = '';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }
    countEl.textContent = (currentIdx + 1) + ' of ' + total;
    prevBtn.disabled = false;
    nextBtn.disabled = false;
  }

  function highlight(idx) {
    marks.forEach(function(m) { m.classList.remove('active-match'); });
    if (idx >= 0 && idx < marks.length) {
      currentIdx = idx;
      marks[idx].classList.add('active-match');
      marks[idx].scrollIntoView({ block: 'center', behavior: 'smooth' });
    }
    updateNav();
  }

  return {
    search: function(query) {
      var text = getOriginal();
      if (!el) return;
      if (!query || query.length < 2) {
        /* Restore formatted DOM if section headings were applied */
        if (el._formattedFragment) {
          el.textContent = '';
          el.appendChild(el._formattedFragment.cloneNode(true));
        } else {
          el.textContent = text;
        }
        marks = [];
        currentIdx = -1;
        countEl.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      var escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      var re = new RegExp(escaped, 'gi');
      var frag = document.createDocumentFragment();
      var lastIndex = 0, match;
      while ((match = re.exec(text)) !== null) {
        if (match.index > lastIndex) frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
        var mark = document.createElement('mark');
        mark.textContent = match[0];
        frag.appendChild(mark);
        lastIndex = re.lastIndex;
      }
      if (lastIndex < text.length) frag.appendChild(document.createTextNode(text.slice(lastIndex)));
      el.textContent = '';
      el.appendChild(frag);
      marks = Array.from(el.querySelectorAll('mark'));
      currentIdx = marks.length > 0 ? 0 : -1;
      if (currentIdx >= 0) highlight(0);
      else { countEl.textContent = 'No matches'; prevBtn.disabled = true; nextBtn.disabled = true; }
    },
    next: function() {
      if (marks.length === 0) return;
      highlight((currentIdx + 1) % marks.length);
    },
    prev: function() {
      if (marks.length === 0) return;
      highlight((currentIdx - 1 + marks.length) % marks.length);
    },
    download: function() {
      var text = getOriginal();
      var blob = new Blob([text], { type: 'text/plain' });
      var a = document.createElement('a');
      var url = URL.createObjectURL(blob);
      a.href = url;
      a.download = '{{ (case.citation or case.case_id)|e }}'.replace(/[^\w\s\-\[\]]/g, '_') + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    },
    toggleExpand: function() {
      if (!el) return;
      var isExpanded = el.classList.toggle('expanded');
      document.getElementById('expandLabel').textContent = isExpanded ? 'Collapse text' : 'Show full text';
    }
  };
})();

/* Ctrl+F override for text search */
document.addEventListener('keydown', function(e) {
  var searchInput = document.getElementById('textSearch');
  if (!searchInput) return;

  /* Ctrl/Cmd+F → focus custom search */
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    var textViewer = document.querySelector('.case-text-viewer');
    if (textViewer) {
      e.preventDefault();
      searchInput.focus();
      searchInput.select();
    }
  }

  /* Enter/Shift+Enter for next/prev match when search focused */
  if (document.activeElement === searchInput && e.key === 'Enter') {
    e.preventDefault();
    if (e.shiftKey) textSearchHandler.prev();
    else textSearchHandler.next();
  }
});

/* e = edit shortcut */
document.addEventListener('keydown', function(e) {
  var tag = document.activeElement ? document.activeElement.tagName : '';
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
  if (e.key === 'e' && !e.ctrlKey && !e.metaKey) {
    window.location.href = '{{ url_for("case_edit", case_id=case.case_id) }}';
  }
});

/* Format legal document sections on load */
(function() {
  var el = document.getElementById('caseTextContent');
  if (!el) return;

  /* Detect section headings in full text (common in AustLII decisions) */
  var sectionPatterns = /^(CATCHWORDS|DECISION|REASONS|REASONS FOR DECISION|ORDER|ORDERS|BACKGROUND|FINDINGS|CONSIDERATION|THE ISSUES?|LEGISLATION|STATUTORY FRAMEWORK|JURISDICTION|EVIDENCE|SUBMISSIONS?|APPLICANT'S? (?:CASE|CLAIMS?)|RESPONDENT'S? (?:CASE|SUBMISSIONS?)|CONCLUSION|SUMMARY|INTRODUCTION|COSTS?|RELIEF|VISA SUBCLASS|GROUND(?:S?) OF REVIEW)\s*$/gm;

  var text = el.textContent;
  el._original = text;  /* Preserve for search */

  var frag = document.createDocumentFragment();
  var lastIndex = 0, match;
  while ((match = sectionPatterns.exec(text)) !== null) {
    if (match.index > lastIndex) {
      frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
    }
    var span = document.createElement('span');
    span.className = 'section-heading';
    span.textContent = match[0];
    frag.appendChild(span);
    lastIndex = sectionPatterns.lastIndex;
  }
  if (lastIndex < text.length) {
    frag.appendChild(document.createTextNode(text.slice(lastIndex)));
  }
  if (lastIndex > 0) {
    el.textContent = '';
    el.appendChild(frag);
    /* Save formatted state so search can restore it after clearing */
    var saved = document.createDocumentFragment();
    Array.from(el.childNodes).forEach(function(n) { saved.appendChild(n.cloneNode(true)); });
    el._formattedFragment = saved;
  }
})();

/* Auto-hide expand toggle if content fits */
(function() {
  var el = document.getElementById('caseTextContent');
  var toggle = document.getElementById('textExpandToggle');
  if (el && toggle) {
    if (el.scrollHeight <= el.clientHeight + 10) toggle.style.display = 'none';
  }
})();
</script>
{% endblock %}
