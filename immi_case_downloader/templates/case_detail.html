{% extends "base.html" %}
{% block title %}{{ case.citation or case.title[:40] }}{% endblock %}

{% block content %}
<!-- Hero / header -->
<div class="case-hero">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-2 small">
      <li class="breadcrumb-item"><a href="{{ url_for('case_list') }}" class="text-decoration-none">Cases</a></li>
      <li class="breadcrumb-item active">{{ case.citation or case.case_id[:12] }}</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <div class="citation-display">
        {{ case.citation or 'No citation' }}
        {% if case.citation %}
        <button class="copy-btn" data-copy="{{ case.citation|e }}" title="Copy citation" aria-label="Copy citation"><i class="bi bi-clipboard"></i></button>
        {% endif %}
        <span class="badge badge-court badge-{{ case.court_code }} ms-1">{{ case.court_code }}</span>
        {% if case.case_nature %}<span class="badge badge-nature badge-nature-{{ case.case_nature | lower | replace(' ', '-') }} ms-1">{{ case.case_nature }}</span>{% endif %}
        {% if case.outcome %}
          {% set ol = case.outcome.lower() %}
          <span class="badge badge-outcome {% if 'affirm' in ol or 'dismiss' in ol or 'refus' in ol %}affirm{% elif 'set aside' in ol or 'allow' in ol or 'remit' in ol or 'grant' in ol %}setaside{% else %}unknown{% endif %}">
            {% if 'affirm' in ol %}Affirmed{% elif 'dismiss' in ol %}Dismissed{% elif 'set aside' in ol %}Set aside{% elif 'allow' in ol %}Allowed{% elif 'remit' in ol %}Remitted{% elif 'grant' in ol %}Granted{% elif 'refus' in ol %}Refused{% else %}Decided{% endif %}
          </span>
        {% endif %}
      </div>
      <div class="case-title mt-1">{{ case.title }}</div>
    </div>
    <div class="d-flex gap-2 flex-shrink-0">
      {% if case.url %}<a href="{{ case.url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary"><i class="bi bi-box-arrow-up-right me-1"></i>Source</a>{% endif %}
      <a href="{{ url_for('case_edit', case_id=case.case_id) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil me-1"></i>Edit</a>
      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" aria-label="Delete case"><i class="bi bi-trash"></i></button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade delete-modal" id="deleteModal" tabindex="-1" aria-label="Confirm delete">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title font-serif"><i class="bi bi-exclamation-triangle me-2" style="color:var(--immi-danger);"></i>Delete Case</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body small">
        <p>Are you sure you want to permanently delete this case?</p>
        <p class="fw-semibold mb-0">{{ case.citation or case.title[:50] }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{{ url_for('case_delete', case_id=case.case_id) }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash me-1"></i>Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Metadata grid -->
<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">Case Details</div>
      <div class="card-body">
        <div class="meta-grid">
          <div class="meta-item"><div class="meta-label">Court / Tribunal</div><div class="meta-value"><span class="badge badge-court badge-{{ case.court_code }} me-1">{{ case.court_code }}</span>{{ case.court }}</div></div>
          <div class="meta-item"><div class="meta-label">Decision Date</div><div class="meta-value">{{ case.date or 'Unknown' }}</div></div>
          <div class="meta-item"><div class="meta-label">Year</div><div class="meta-value">{{ case.year or 'Unknown' }}</div></div>
          <div class="meta-item"><div class="meta-label">Judge(s) / Member(s)</div><div class="meta-value">{{ case.judges or 'Not extracted' }}</div></div>
          <div class="meta-item"><div class="meta-label">Visa Type</div><div class="meta-value">{{ case.visa_type or 'Not detected' }}</div></div>
          <div class="meta-item"><div class="meta-label">Source</div><div class="meta-value">{{ case.source }}</div></div>
        </div>

        {% if case.outcome %}
        <div class="mt-3 p-2 rounded" style="background:var(--immi-surface);">
          <div class="meta-label mb-1">Outcome / Decision</div>
          <div class="small">{{ case.outcome }}</div>
        </div>
        {% endif %}

        {% if case.legislation %}
        <div class="mt-2 p-2 rounded" style="background:var(--immi-surface);">
          <div class="meta-label mb-1">Legislation</div>
          <div class="small">{{ case.legislation }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Notes & Tags -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        Notes & Tags
        <a href="{{ url_for('case_edit', case_id=case.case_id) }}" class="btn btn-sm btn-outline-secondary py-0 px-1" aria-label="Edit notes"><i class="bi bi-pencil"></i></a>
      </div>
      <div class="card-body">
        {% if case.tags %}
        <div class="mb-2">{% for tag in case.tags.split(',') %}{% set t = tag.strip() %}{% if t %}<a href="{{ url_for('case_list', tag=t) }}" class="badge bg-accent-muted text-accent me-1 text-decoration-none">{{ t }}</a>{% endif %}{% endfor %}</div>
        {% endif %}
        {% if case.user_notes %}
        <div class="small" style="white-space:pre-wrap;">{{ case.user_notes }}</div>
        {% else %}
        <p class="text-muted small mb-0">No notes yet. <a href="{{ url_for('case_edit', case_id=case.case_id) }}">Add notes</a></p>
        {% endif %}
      </div>
    </div>

    <!-- Catchwords -->
    <div class="card mb-3">
      <div class="card-header">Catchwords</div>
      <div class="card-body">
        {% if case.catchwords %}
        <div class="small">{{ case.catchwords }}</div>
        {% else %}
        <p class="text-muted small mb-0">Not extracted. Download full text to populate.</p>
        {% endif %}
      </div>
    </div>

    <!-- Legal Concepts -->
    {% if case.legal_concepts %}
    <div class="card">
      <div class="card-header">Legal Concepts</div>
      <div class="card-body">
        {% for concept in case.legal_concepts.split(';') %}{% set c = concept.strip() %}{% if c %}<a href="{{ url_for('case_list', q=c) }}" class="concept-tag">{{ c }}</a>{% endif %}{% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Full text viewer -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Full Case Text</span>
    {% if full_text %}<span class="badge bg-accent-muted text-accent">{{ full_text | length }} chars</span>{% endif %}
  </div>
  {% if full_text %}
  <div class="case-text-viewer">
    <div class="text-toolbar">
      <i class="bi bi-search" style="font-size:.8rem;"></i>
      <input type="text" id="textSearch" placeholder="Search within case text..." oninput="searchInText(this.value)">
      <span class="small text-muted" id="searchCount"></span>
      <button class="btn btn-sm btn-outline-secondary py-0 ms-auto" onclick="window.print()" title="Print" aria-label="Print case"><i class="bi bi-printer"></i></button>
    </div>
    <div class="text-content" id="caseTextContent">{{ full_text }}</div>
  </div>
  {% else %}
  <div class="card-body">
    <div class="empty-state py-4">
      <div class="empty-icon" style="font-size:2rem;"><i class="bi bi-file-earmark-text"></i></div>
      <p class="text-muted">Full text not yet downloaded.</p>
      <a href="{{ url_for('download_page') }}" class="btn btn-outline-primary btn-sm">Download Case Texts</a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/* Copy button */
document.querySelectorAll('.copy-btn[data-copy]').forEach(function(btn) {
  btn.addEventListener('click', function() {
    navigator.clipboard.writeText(btn.getAttribute('data-copy')).then(function() {
      btn.classList.add('copied');
      var icon = btn.querySelector('i');
      icon.className = 'bi bi-check';
      setTimeout(function() { btn.classList.remove('copied'); icon.className = 'bi bi-clipboard'; }, 2000);
    });
  });
});

/* In-text search */
function searchInText(query) {
  var el = document.getElementById('caseTextContent');
  var countEl = document.getElementById('searchCount');
  if (!el._original) el._original = el.textContent;
  if (!query || query.length < 2) { el.textContent = el._original; countEl.textContent = ''; return; }
  var text = el._original;
  var escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  var re = new RegExp(escaped, 'gi');
  var frag = document.createDocumentFragment();
  var lastIndex = 0, match, count = 0;
  while ((match = re.exec(text)) !== null) {
    count++;
    if (match.index > lastIndex) frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
    var mark = document.createElement('mark');
    mark.textContent = match[0];
    frag.appendChild(mark);
    lastIndex = re.lastIndex;
  }
  if (lastIndex < text.length) frag.appendChild(document.createTextNode(text.slice(lastIndex)));
  countEl.textContent = count ? count + ' found' : 'No matches';
  el.textContent = '';
  el.appendChild(frag);
}

/* e = edit shortcut */
document.addEventListener('keydown', function(e) {
  var tag = document.activeElement ? document.activeElement.tagName : '';
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
  if (e.key === 'e' && !e.ctrlKey && !e.metaKey) {
    window.location.href = '{{ url_for("case_edit", case_id=case.case_id) }}';
  }
});
</script>
{% endblock %}
