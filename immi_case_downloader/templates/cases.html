{% extends "base.html" %}
{% block title %}Browse Cases{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Browse Cases <small class="text-muted fs-6">({{ total }} results)</small></h2>
  <div>
    <a href="{{ url_for('case_add') }}" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i>Add Case</a>
    <a href="{{ url_for('export_data', fmt='csv') }}" class="btn btn-sm btn-outline-success"><i class="bi bi-download me-1"></i>Export CSV</a>
  </div>
</div>

<!-- Filters -->
<div class="card shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label small mb-0">Keyword</label>
        <input type="text" name="q" class="form-control form-control-sm" value="{{ filters.q }}" placeholder="Search titles, judges...">
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Court</label>
        <select name="court" class="form-select form-select-sm">
          <option value="">All Courts</option>
          {% for code in courts %}
          <option value="{{ code }}" {% if filters.court == code %}selected{% endif %}>
            {{ databases.get(code, {}).get('name', code) if code in databases else code }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <label class="form-label small mb-0">Year</label>
        <select name="year" class="form-select form-select-sm">
          <option value="">All</option>
          {% for y in years %}
          <option value="{{ y }}" {% if filters.year == y|string %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-0">Visa Type</label>
        <input type="text" name="visa_type" class="form-control form-control-sm" value="{{ filters.visa_type }}" placeholder="e.g. protection">
      </div>
      <div class="col-md-1">
        <label class="form-label small mb-0">Source</label>
        <select name="source" class="form-select form-select-sm">
          <option value="">All</option>
          {% for s in sources %}
          <option value="{{ s }}" {% if filters.source == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <label class="form-label small mb-0">Tag</label>
        <select name="tag" class="form-select form-select-sm">
          <option value="">All</option>
          {% for t in all_tags %}
          <option value="{{ t }}" {% if filters.tag == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <label class="form-label small mb-0">Sort</label>
        <select name="sort" class="form-select form-select-sm">
          <option value="year" {% if filters.sort == 'year' %}selected{% endif %}>Year</option>
          <option value="date" {% if filters.sort == 'date' %}selected{% endif %}>Date</option>
          <option value="title" {% if filters.sort == 'title' %}selected{% endif %}>Title</option>
          <option value="court" {% if filters.sort == 'court' %}selected{% endif %}>Court</option>
        </select>
      </div>
      <div class="col-md-1">
        <label class="form-label small mb-0">Dir</label>
        <select name="dir" class="form-select form-select-sm">
          <option value="desc" {% if filters.dir == 'desc' %}selected{% endif %}>Newest</option>
          <option value="asc" {% if filters.dir == 'asc' %}selected{% endif %}>Oldest</option>
        </select>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Cases table -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover table-cases mb-0">
      <thead class="table-light">
        <tr>
          <th>Citation</th>
          <th>Title</th>
          <th>Court</th>
          <th>Year</th>
          <th>Date</th>
          <th>Visa Type</th>
          <th>Text</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for case in cases %}
        <tr>
          <td><a href="{{ url_for('case_detail', case_id=case.case_id) }}" class="text-decoration-none fw-semibold">{{ case.citation or '---' }}</a></td>
          <td class="truncate" title="{{ case.title }}">{{ case.title[:80] }}{% if case.title|length > 80 %}...{% endif %}</td>
          <td>
            <span class="badge bg-secondary badge-court">{{ case.court_code }}</span>
          </td>
          <td>{{ case.year or '' }}</td>
          <td class="text-nowrap">{{ case.date or '' }}</td>
          <td>{{ case.visa_type or '' }}</td>
          <td class="text-center">
            {% if case.full_text_path %}
            <i class="bi bi-check-circle-fill text-success" title="Full text available"></i>
            {% else %}
            <i class="bi bi-dash text-muted"></i>
            {% endif %}
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <a href="{{ url_for('case_detail', case_id=case.case_id) }}" class="btn btn-outline-primary btn-sm" title="View"><i class="bi bi-eye"></i></a>
              <a href="{{ url_for('case_edit', case_id=case.case_id) }}" class="btn btn-outline-secondary btn-sm" title="Edit"><i class="bi bi-pencil"></i></a>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not cases %}
        <tr><td colspan="8" class="text-center text-muted py-4">No cases found. Try adjusting filters or <a href="{{ url_for('search_page') }}">search for cases</a>.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-3">
  <ul class="pagination pagination-sm justify-content-center">
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a class="page-link" href="?page={{ page - 1 }}&{{ request.query_string.decode().replace('page=' ~ page, '') }}">Prev</a>
    </li>
    {% for p in range(1, total_pages + 1) %}
      {% if p == page or (p >= page - 2 and p <= page + 2) or p == 1 or p == total_pages %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="?page={{ p }}&court={{ filters.court }}&year={{ filters.year }}&q={{ filters.q }}&visa_type={{ filters.visa_type }}&source={{ filters.source }}&tag={{ filters.tag }}&sort={{ filters.sort }}&dir={{ filters.dir }}">{{ p }}</a>
      </li>
      {% elif p == page - 3 or p == page + 3 %}
      <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="?page={{ page + 1 }}&court={{ filters.court }}&year={{ filters.year }}&q={{ filters.q }}&visa_type={{ filters.visa_type }}&source={{ filters.source }}&tag={{ filters.tag }}&sort={{ filters.sort }}&dir={{ filters.dir }}">Next</a>
    </li>
  </ul>
</nav>
{% endif %}
{% endblock %}
