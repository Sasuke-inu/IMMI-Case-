{% extends "base.html" %}
{% block title %}Smart Pipeline{% endblock %}

{% block content %}
<nav aria-label="breadcrumb"><ol class="breadcrumb small">
  <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li class="breadcrumb-item active">Smart Pipeline</li>
</ol></nav>
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0 font-serif"><i class="bi bi-gear-wide-connected me-2"></i>Smart Pipeline</h4>
    <small class="text-muted">Automated crawl &rarr; clean &rarr; download with auto-fallback</small>
  </div>
  {% if pipeline.running %}
  <button class="btn btn-outline-danger btn-sm" onclick="stopPipeline()"><i class="bi bi-stop-circle me-1"></i>Stop</button>
  {% endif %}
</div>

{% if not pipeline.running and not pipeline.phases_completed %}
<!-- ═══════════ CONFIGURATION SECTION ═══════════ -->
<div class="row g-3">
  <div class="col-lg-8">
    <!-- Presets -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-lightning-charge me-1 text-accent"></i>Quick Presets</span>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-4">
            <form method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="preset" value="quick">
              <input type="hidden" name="delay" value="0.5">
              <input type="hidden" name="download_enabled" value="on">
              <button type="submit" class="btn btn-success w-100 py-3">
                <i class="bi bi-lightning-charge d-block mb-1" style="font-size:1.5rem;"></i>
                <strong>Quick Update</strong>
                <div class="small opacity-75">Current + previous year, all DBs</div>
              </button>
            </form>
          </div>
          <div class="col-md-4">
            <form method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="preset" value="full">
              <input type="hidden" name="delay" value="1.0">
              <input type="hidden" name="download_enabled" value="on">
              <button type="submit" class="btn btn-primary w-100 py-3">
                <i class="bi bi-collection d-block mb-1" style="font-size:1.5rem;"></i>
                <strong>Full Crawl</strong>
                <div class="small opacity-75">All DBs, 2010&ndash;{{ end_year }}</div>
              </button>
            </form>
          </div>
          <div class="col-md-4">
            <form method="post">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="preset" value="download_only">
              <input type="hidden" name="download_enabled" value="on">
              <input type="hidden" name="download_batch_size" value="1000">
              <button type="submit" class="btn w-100 py-3" style="background:var(--immi-accent);color:#fff;border:none;">
                <i class="bi bi-cloud-download d-block mb-1" style="font-size:1.5rem;"></i>
                <strong>Download Only</strong>
                <div class="small opacity-75">{{ "{:,}".format(without_text) }} texts pending</div>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Config -->
    <div class="card mb-3">
      <div class="card-header"><i class="bi bi-sliders me-1"></i>Custom Pipeline</div>
      <div class="card-body">
        <form method="post" id="customPipelineForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="preset" value="custom">
          <div class="mb-3">
            <label class="form-label small fw-semibold">Databases</label>
            <div class="row g-2">
              {% for code, info in databases.items() %}
              {% if code not in ('RRTA', 'MRTA') %}
              <div class="col-6 col-lg-4">
                <label class="source-card d-flex align-items-center gap-2 w-100 {{ 'selected' if code in ('AATA', 'ARTA', 'FCA', 'FedCFamC2G') }}" for="pl_db_{{ code }}">
                  <input type="checkbox" name="databases" value="{{ code }}" id="pl_db_{{ code }}"
                    {{ 'checked' if code in ('AATA', 'ARTA', 'FCA', 'FedCFamC2G') }}
                    onchange="this.closest('.source-card').classList.toggle('selected', this.checked)">
                  <div>
                    <span class="badge badge-court badge-{{ code }}">{{ code }}</span>
                    <div class="small text-muted mt-1">{{ info.name }}</div>
                  </div>
                </label>
              </div>
              {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-3">
              <label class="form-label small" for="pl_start_year">Start Year</label>
              <input type="number" name="start_year" id="pl_start_year" class="form-control form-control-sm" value="{{ end_year - 1 }}" min="2000" max="2030">
            </div>
            <div class="col-md-3">
              <label class="form-label small" for="pl_end_year">End Year</label>
              <input type="number" name="end_year" id="pl_end_year" class="form-control form-control-sm" value="{{ end_year }}" min="2000" max="2030">
            </div>
            <div class="col-md-3">
              <label class="form-label small" for="pl_delay">Request Delay</label>
              <select name="delay" id="pl_delay" class="form-select form-select-sm">
                <option value="0.3">0.3s (fast)</option>
                <option value="0.5" selected>0.5s (balanced)</option>
                <option value="1.0">1.0s (gentle)</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label small" for="pl_batch">Download Batch</label>
              <select name="download_batch_size" id="pl_batch" class="form-select form-select-sm">
                <option value="500">500</option>
                <option value="1000" selected>1,000</option>
                <option value="5000">5,000</option>
              </select>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-auto">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="auto_rotate" id="pl_auto_rotate" checked>
                <label class="form-check-label small" for="pl_auto_rotate">Auto-rotate strategies</label>
              </div>
            </div>
            <div class="col-auto">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="fix_year_zero" id="pl_fix_year" checked>
                <label class="form-check-label small" for="pl_fix_year">Fix year=0</label>
              </div>
            </div>
            <div class="col-auto">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="deduplicate" id="pl_dedup" checked>
                <label class="form-check-label small" for="pl_dedup">Deduplicate</label>
              </div>
            </div>
            <div class="col-auto">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="download_enabled" id="pl_download" checked value="on">
                <label class="form-check-label small" for="pl_download">Download full text</label>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-success"><i class="bi bi-play-fill me-1"></i>Start Pipeline</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Right column: Info -->
  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-header"><i class="bi bi-info-circle me-1"></i>Current Data</div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span class="small text-muted">Total Cases</span>
          <span class="fw-semibold">{{ "{:,}".format(total_cases) }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="small text-muted">With Full Text</span>
          <span class="fw-semibold" style="color:var(--immi-success);">{{ "{:,}".format(total_cases - without_text) }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="small text-muted">Missing Full Text</span>
          <span class="fw-semibold" style="color:var(--immi-warning);">{{ "{:,}".format(without_text) }}</span>
        </div>
      </div>
    </div>

    <div class="card border-accent">
      <div class="card-body small">
        <div class="fw-semibold mb-2 font-serif"><i class="bi bi-diagram-3 me-1 text-accent"></i>Pipeline Phases</div>
        <ol class="mb-0 ps-3" style="font-size:.8rem;">
          <li class="mb-1"><strong>Crawl</strong> &mdash; Scrape AustLII with auto-fallback (direct &rarr; viewdb &rarr; keyword search)</li>
          <li class="mb-1"><strong>Clean</strong> &mdash; Fix year=0, deduplicate by URL, validate fields</li>
          <li><strong>Download</strong> &mdash; Fetch full judgment texts with retry queue</li>
        </ol>
      </div>
    </div>
  </div>
</div>

{% else %}
<!-- ═══════════ LIVE MONITOR SECTION ═══════════ -->
<div id="monitor-section"
     data-status-url="{{ url_for('pipeline_status_api') }}"
     data-log-url="{{ url_for('pipeline_log_api') }}"
     data-action-url="{{ url_for('pipeline_action_api') }}"
     data-running="{{ 'true' if pipeline.running else 'false' }}"
     data-log-count="{{ pipeline.log | length }}">

  <!-- Phase progress -->
  <div class="card mb-3">
    <div class="card-header d-flex align-items-center gap-2">
      {% if pipeline.running %}
      <span class="spinner-border spinner-border-sm" style="color:var(--immi-accent);"></span>
      <span class="fw-semibold">Pipeline Running</span>
      <span class="ms-auto badge" style="background:var(--immi-accent);color:#fff;" id="elapsed-badge">Running...</span>
      {% else %}
      <i class="bi bi-check-circle-fill" style="color:var(--immi-success);"></i>
      <span class="fw-semibold">Pipeline Complete</span>
      {% endif %}
    </div>
    <div class="card-body">
      <!-- Phase indicators -->
      <div class="d-flex justify-content-center gap-4 mb-3">
        <div class="text-center" id="phase-crawl">
          <div class="phase-indicator {% if 'crawl' in pipeline.phases_completed %}completed{% elif pipeline.phase == 'crawl' %}active{% else %}pending{% endif %}">
            {% if 'crawl' in pipeline.phases_completed %}<i class="bi bi-check-lg"></i>{% elif pipeline.phase == 'crawl' %}<span class="spinner-border spinner-border-sm"></span>{% else %}<i class="bi bi-search"></i>{% endif %}
          </div>
          <div class="small mt-1 fw-semibold">Crawl</div>
        </div>
        <div class="d-flex align-items-center text-muted"><i class="bi bi-arrow-right"></i></div>
        <div class="text-center" id="phase-clean">
          <div class="phase-indicator {% if 'clean' in pipeline.phases_completed %}completed{% elif pipeline.phase == 'clean' %}active{% else %}pending{% endif %}">
            {% if 'clean' in pipeline.phases_completed %}<i class="bi bi-check-lg"></i>{% elif pipeline.phase == 'clean' %}<span class="spinner-border spinner-border-sm"></span>{% else %}<i class="bi bi-funnel"></i>{% endif %}
          </div>
          <div class="small mt-1 fw-semibold">Clean</div>
        </div>
        <div class="d-flex align-items-center text-muted"><i class="bi bi-arrow-right"></i></div>
        <div class="text-center" id="phase-download">
          <div class="phase-indicator {% if 'download' in pipeline.phases_completed %}completed{% elif pipeline.phase == 'download' %}active{% else %}pending{% endif %}">
            {% if 'download' in pipeline.phases_completed %}<i class="bi bi-check-lg"></i>{% elif pipeline.phase == 'download' %}<span class="spinner-border spinner-border-sm"></span>{% else %}<i class="bi bi-cloud-download"></i>{% endif %}
          </div>
          <div class="small mt-1 fw-semibold">Download</div>
        </div>
      </div>

      <!-- Progress bar -->
      <p class="text-muted small mb-2" id="progress-text">{{ pipeline.phase_progress }}</p>
      <div class="progress mb-3" role="progressbar" style="height:20px;">
        <div class="progress-bar progress-bar-striped {% if pipeline.running %}progress-bar-animated{% endif %} {% if pipeline.overall_progress > 80 %}bg-success{% endif %}"
             id="progress-bar" style="width:{{ pipeline.overall_progress }}%; background-color:var(--immi-accent);">
          {{ pipeline.overall_progress }}%
        </div>
      </div>

      <!-- Strategy badge -->
      {% if pipeline.running and pipeline.current_strategy %}
      <div class="mb-3">
        <span class="small text-muted me-1">Active strategy:</span>
        <span class="badge {% if pipeline.current_strategy == 'direct' %}bg-success{% elif pipeline.current_strategy == 'viewdb' %}bg-warning text-dark{% else %}bg-info{% endif %}" id="strategy-badge">{{ pipeline.current_strategy }}</span>
      </div>
      {% endif %}

      <!-- Stats cards -->
      <div class="row g-2 mb-3" id="stats-cards">
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center" style="border-color:var(--immi-border);">
            <div class="small text-muted">Found</div>
            <div class="fw-bold" id="stat-found">{{ pipeline.stats.crawl.total_found }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center" style="border-color:var(--immi-border);">
            <div class="small text-muted">New Added</div>
            <div class="fw-bold" style="color:var(--immi-success);" id="stat-new">{{ pipeline.stats.crawl.new_added }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center" style="border-color:var(--immi-border);">
            <div class="small text-muted">Downloaded</div>
            <div class="fw-bold" style="color:var(--immi-info);" id="stat-downloaded">{{ pipeline.stats.download.downloaded }}</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="border rounded p-2 text-center" style="border-color:var(--immi-border);">
            <div class="small text-muted">Errors</div>
            <div class="fw-bold" style="color:var(--immi-danger);" id="stat-errors">{{ pipeline.errors | length }}</div>
          </div>
        </div>
      </div>

      <!-- Clean stats -->
      {% if 'clean' in pipeline.phases_completed %}
      <div class="row g-2 mb-3">
        <div class="col-auto"><span class="badge bg-accent-muted text-accent"><i class="bi bi-calendar-check me-1"></i>Year fixed: {{ pipeline.stats.clean.year_fixed }}</span></div>
        <div class="col-auto"><span class="badge bg-accent-muted text-accent"><i class="bi bi-layers me-1"></i>Dupes removed: {{ pipeline.stats.clean.dupes_removed }}</span></div>
        <div class="col-auto"><span class="badge bg-accent-muted text-accent"><i class="bi bi-patch-check me-1"></i>Validated: {{ pipeline.stats.clean.validated }}</span></div>
      </div>
      {% endif %}

      {% if not pipeline.running %}
      <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('case_list') }}" class="btn btn-primary btn-sm"><i class="bi bi-folder2-open me-1"></i>View Cases</a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a>
        <a href="{{ url_for('pipeline_page') }}" class="btn btn-outline-success btn-sm"><i class="bi bi-arrow-repeat me-1"></i>New Pipeline</a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Debug Log Panel -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#logPanel" style="cursor:pointer;">
      <span><i class="bi bi-terminal me-1"></i>Debug Log <span class="badge bg-secondary ms-1" id="log-count">{{ pipeline.log | length }}</span></span>
      <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse show" id="logPanel">
      <div class="card-body pb-0 pt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group" id="log-filters">
          <button type="button" class="btn btn-outline-secondary active" data-filter="">All</button>
          <button type="button" class="btn btn-outline-danger" data-filter="error">Errors</button>
          <button type="button" class="btn btn-outline-warning" data-filter="warn">Warnings</button>
          <button type="button" class="btn btn-outline-info" data-filter="strategy_switch">Strategy</button>
          <button type="button" class="btn btn-outline-success" data-filter="success">Success</button>
        </div>
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleAutoScroll()" id="scroll-btn" title="Toggle auto-scroll" aria-label="Toggle auto-scroll">
            <i class="bi bi-arrow-down-circle"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="exportLog()" title="Export log as JSON" aria-label="Export log">
            <i class="bi bi-download"></i>
          </button>
        </div>
      </div>
      <div class="card-body pt-2">
        <div id="log-container" style="max-height:400px; overflow-y:auto; font-family:var(--font-mono); font-size:.72rem;">
          {% for event in pipeline.log[-50:] %}
          <div class="log-entry d-flex gap-2 py-1 border-bottom" data-level="{{ event.level }}" data-category="{{ event.category }}">
            <span class="text-muted" style="min-width:70px;">{{ event.timestamp[-8:] }}</span>
            <span class="badge {% if event.phase == 'crawl' %}bg-primary{% elif event.phase == 'clean' %}bg-info{% elif event.phase == 'download' %}bg-warning text-dark{% else %}bg-secondary{% endif %}" style="min-width:55px;">{{ event.phase }}</span>
            <span>
              {% if event.level == 'error' %}<i class="bi bi-x-circle-fill text-danger"></i>
              {% elif event.level == 'warn' %}<i class="bi bi-exclamation-triangle-fill text-warning"></i>
              {% elif event.level == 'success' %}<i class="bi bi-check-circle-fill text-success"></i>
              {% else %}<i class="bi bi-info-circle text-muted"></i>{% endif %}
            </span>
            <span class="flex-grow-1">{{ event.message }}</span>
          </div>
          {% endfor %}
          {% if not pipeline.log %}<div class="text-muted text-center py-3">No log events yet.</div>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Stop Pipeline Modal -->
  <div class="modal fade" id="stopPipelineModal" tabindex="-1" aria-label="Confirm stop">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title font-serif">Stop Pipeline</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body small">Stop the running pipeline? Progress will be saved.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="confirmStopPipeline()"><i class="bi bi-stop-circle me-1"></i>Stop</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='pipeline-monitor.js') }}"></script>
{% endblock %}
