{% extends "base.html" %}
{% block title %}Job Status{% endblock %}

{% block content %}
<h2 class="mb-4">Job Status</h2>

<div class="card shadow-sm" id="job-card">
  <div class="card-body">
    {% if job.running %}
    <div class="d-flex align-items-center mb-3">
      <div class="spinner-border text-primary me-3" role="status"></div>
      <div>
        <h5 class="mb-0">{{ job.type | capitalize }} in Progress</h5>
        <p class="text-muted mb-0" id="progress-text">{{ job.progress }}</p>
      </div>
    </div>

    {% if job.total > 0 %}
    <div class="progress mb-3" style="height: 24px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated"
           id="progress-bar"
           style="width: {{ (job.completed / job.total * 100) | int }}%">
        {{ job.completed }} / {{ job.total }}
      </div>
    </div>
    {% endif %}

    {% else %}

    {% if job.type %}
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-check-circle-fill fs-3 text-success me-3"></i>
      <div>
        <h5 class="mb-0">{{ job.type | capitalize }} Complete</h5>
        <p class="text-muted mb-0">{{ job.progress }}</p>
      </div>
    </div>
    {% else %}
    <div class="text-center py-4">
      <i class="bi bi-clock-history fs-1 text-muted"></i>
      <p class="text-muted mt-2">No jobs running. Start a <a href="{{ url_for('search_page') }}">search</a> or <a href="{{ url_for('download_page') }}">download</a>.</p>
    </div>
    {% endif %}
    {% endif %}

    {% if job.results %}
    <h6>Results</h6>
    <ul class="list-group list-group-flush mb-3">
      {% for r in job.results %}
      <li class="list-group-item py-1 small"><i class="bi bi-check text-success me-1"></i>{{ r }}</li>
      {% endfor %}
    </ul>
    {% endif %}

    {% if job.errors %}
    <h6 class="text-danger">Errors ({{ job.errors | length }})</h6>
    <div class="border border-danger rounded p-2" style="max-height: 200px; overflow-y: auto;">
      {% for e in job.errors %}
      <div class="small text-danger">{{ e }}</div>
      {% endfor %}
    </div>
    {% endif %}

    {% if not job.running and job.type %}
    <hr>
    <a href="{{ url_for('case_list') }}" class="btn btn-primary"><i class="bi bi-folder2-open me-1"></i>View Cases</a>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if job.running %}
<script>
  // Auto-refresh job status every 3 seconds
  function refreshStatus() {
    fetch('{{ url_for("job_status_api") }}')
      .then(r => r.json())
      .then(data => {
        document.getElementById('progress-text').textContent = data.progress;
        if (data.total > 0) {
          const pct = Math.round(data.completed / data.total * 100);
          const bar = document.getElementById('progress-bar');
          bar.style.width = pct + '%';
          bar.textContent = data.completed + ' / ' + data.total;
        }
        if (!data.running) {
          // Job finished, reload page for final state
          window.location.reload();
        } else {
          setTimeout(refreshStatus, 3000);
        }
      })
      .catch(() => setTimeout(refreshStatus, 5000));
  }
  setTimeout(refreshStatus, 3000);
</script>
{% endif %}
{% endblock %}
