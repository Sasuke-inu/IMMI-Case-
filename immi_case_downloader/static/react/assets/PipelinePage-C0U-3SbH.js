import{j as e,c as O,u as Q,b as K}from"./query-DQVcjD57.js";import{r as m}from"./vendor-CxW-pF4z.js";import{p as U,a as Z}from"./api-mEKAgK73.js";import{u as J}from"./use-stats-D0NyBjBZ.js";import{S as f}from"./StatCard-BbxFUF4Q.js";import{c as G,a as _,u as V,t as q}from"./index-Bnk0r1Pl.js";import{D as j}from"./database-BUn9oBAV.js";import{G as A}from"./git-branch-BQqooFE-.js";import{D as k}from"./download-C5MK6Xwo.js";import{L as F}from"./loader-circle-hWMnE_3f.js";import{C as E,a as W}from"./circle-check-big-LTZcUaVl.js";import{C as X,a as ee}from"./chevron-up-BWZp7hxx.js";import{P as se}from"./play-CApvUAB8.js";import{C as te}from"./clock-PVr68sTa.js";import"./charts-CKTqRh7i.js";const ae=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],re=G("square",ae);const le=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],ne=G("zap",le),de={success:"bg-success/10 text-success",warning:"bg-warning/10 text-warning",danger:"bg-danger/10 text-danger",info:"bg-info/10 text-info"};function ie({code:b,name:t,badge:x,badgeColor:u="info",disabled:l=!1,disabledReason:p,selected:h,onToggle:g}){return e.jsxs("button",{onClick:()=>!l&&g(b),disabled:l,className:_("flex items-start gap-3 rounded-lg border p-3 text-left transition-all",l?"cursor-not-allowed border-border bg-surface opacity-50":h?"border-accent bg-accent-muted shadow-sm":"border-border bg-card hover:border-accent/50"),title:l?p:void 0,children:[e.jsx("div",{className:_("mt-0.5 rounded-md p-1.5",h?"bg-accent/20 text-accent":"bg-surface text-muted-text"),children:e.jsx(j,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-sm font-semibold text-foreground",children:b}),x&&e.jsx("span",{className:_("rounded-full px-1.5 py-0.5 text-[10px] font-medium",de[u]),children:x})]}),e.jsx("p",{className:"mt-0.5 text-xs text-muted-text truncate",children:t}),l&&p&&e.jsx("p",{className:"mt-0.5 text-[10px] text-danger",children:p})]}),e.jsx("input",{type:"checkbox",checked:h,readOnly:!0,className:"mt-1 rounded",tabIndex:-1})]})}const I=[{code:"ARTA",name:"Administrative Review Tribunal",badge:"New",badgeColor:"success"},{code:"FCA",name:"Federal Court of Australia"},{code:"FedCFamC2G",name:"Federal Circuit & Family Court (Div 2)"},{code:"HCA",name:"High Court of Australia"},{code:"FCCA",name:"Federal Circuit Court of Australia"},{code:"AATA",name:"Administrative Appeals Tribunal",badge:"Ended Oct 2024",badgeColor:"warning"}],c=new Date().getFullYear();function ye(){const b=O(),{t}=V(),{data:x}=J(),[u,l]=m.useState(new Set(["ARTA","FCA","FedCFamC2G","HCA","FCCA"])),[p,h]=m.useState(c-1),[g,H]=m.useState(c),[S,Y]=m.useState("0.5"),[N,z]=m.useState(!1),[v,L]=m.useState(!0),{data:n}=Q({queryKey:["pipeline-status"],queryFn:Z,refetchInterval:s=>s.state.data?.running?2e3:1e4}),i=K({mutationFn:s=>U(s.action,s.params),onSuccess:()=>{b.invalidateQueries({queryKey:["pipeline-status"]}),q.success("Pipeline action executed")},onError:s=>q.error(s.message)}),M=m.useCallback(s=>{l(a=>{const d=new Set(a);return d.has(s)?d.delete(s):d.add(s),d})},[]),w=s=>{const a={};s==="quick"?(a.databases=["ARTA","FCA","FedCFamC2G","HCA","FCCA"],a.start_year=c-1,a.end_year=c,a.delay=.5):s==="full"?(a.databases=["ARTA","FCA","FedCFamC2G","HCA","FCCA","AATA"],a.start_year=2010,a.end_year=c,a.delay=1):(a.databases=["ARTA","FCA","FedCFamC2G","HCA","FCCA"],a.download_only=!0),i.mutate({action:"start",params:a})},R=()=>{i.mutate({action:"start",params:{databases:Array.from(u),start_year:p,end_year:g,delay:Number(S)}})},r=n?.running??!1,D=n?.phase,o=n?.stats,C=n?.log??[],y=n?.errors??[],B=n?.phases_completed??[],P=n?.overall_progress??0,T=[{id:"crawl",label:"Crawl",icon:j,desc:"Browse AustLII year listings, extract case metadata"},{id:"clean",label:"Clean",icon:A,desc:"Deduplicate, fix years, validate records"},{id:"download",label:"Download",icon:k,desc:"Fetch full text, extract structured fields"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"h-6 w-6 text-accent"}),e.jsx("h1",{className:"text-2xl font-semibold text-foreground",children:t("pipeline.title")})]}),e.jsxs("div",{className:"grid gap-4 sm:grid-cols-4",children:[e.jsx(f,{title:t("dashboard.total_cases"),value:x?.total_cases??0,icon:e.jsx(j,{className:"h-5 w-5"})}),e.jsx(f,{title:t("dashboard.with_full_text"),value:x?.with_full_text??0,icon:e.jsx(k,{className:"h-5 w-5"})}),e.jsx(f,{title:t("filters.court"),value:Object.keys(x?.courts??{}).length,icon:e.jsx(A,{className:"h-5 w-5"})}),e.jsx(f,{title:t("pipeline.title"),value:t(r?"states.in_progress":"states.idle"),icon:r?e.jsx(F,{className:"h-5 w-5 animate-spin"}):e.jsx(E,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-card p-5",children:[e.jsx("h2",{className:"mb-3 font-heading text-base font-semibold",children:t("pipeline.quick_preset")}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsxs("button",{onClick:()=>w("quick"),disabled:r||i.isPending,className:"flex flex-col items-center gap-2 rounded-lg border border-border p-5 transition-all hover:border-accent hover:shadow-md disabled:opacity-50",children:[e.jsx("div",{className:"rounded-full bg-accent-muted p-3 text-accent",children:e.jsx(ne,{className:"h-6 w-6"})}),e.jsx("span",{className:"font-medium text-foreground",children:t("pipeline.quick_preset")}),e.jsx("span",{className:"text-xs text-muted-text text-center",children:t("pipeline.quick_preset_subtitle",{yearFrom:c-1,yearTo:c})})]}),e.jsxs("button",{onClick:()=>w("full"),disabled:r||i.isPending,className:"flex flex-col items-center gap-2 rounded-lg border border-border p-5 transition-all hover:border-accent hover:shadow-md disabled:opacity-50",children:[e.jsx("div",{className:"rounded-full bg-info/10 p-3 text-info",children:e.jsx(j,{className:"h-6 w-6"})}),e.jsx("span",{className:"font-medium text-foreground",children:t("pipeline.full_preset")}),e.jsx("span",{className:"text-xs text-muted-text text-center",children:t("pipeline.full_preset_subtitle",{currentYear:c})})]}),e.jsxs("button",{onClick:()=>w("download"),disabled:r||i.isPending,className:"flex flex-col items-center gap-2 rounded-lg border border-border p-5 transition-all hover:border-accent hover:shadow-md disabled:opacity-50",children:[e.jsx("div",{className:"rounded-full bg-success/10 p-3 text-success",children:e.jsx(k,{className:"h-6 w-6"})}),e.jsx("span",{className:"font-medium text-foreground",children:t("pipeline.custom")}),e.jsx("span",{className:"text-xs text-muted-text text-center",children:t("pipeline.download_only_subtitle")})]})]})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-card",children:[e.jsxs("button",{onClick:()=>z(!N),className:"flex w-full items-center justify-between p-5",children:[e.jsx("h2",{className:"font-heading text-base font-semibold",children:t("pipeline.custom_label")}),N?e.jsx(X,{className:"h-5 w-5 text-muted-text"}):e.jsx(ee,{className:"h-5 w-5 text-muted-text"})]}),N&&e.jsxs("div",{className:"border-t border-border p-5 pt-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsxs("span",{className:"text-xs font-medium text-secondary-text",children:[t("pipeline.databases_label")," (",t("pipeline.databases_selected",{count:u.size}),")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>l(new Set(I.map(s=>s.code))),className:"text-xs text-accent hover:underline",children:t("pipeline.select_all")}),e.jsx("button",{onClick:()=>l(new Set),className:"text-xs text-muted-text hover:text-foreground",children:t("pipeline.clear")})]})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2 lg:grid-cols-3",children:I.map(s=>e.jsx(ie,{code:s.code,name:s.name,badge:s.badge,badgeColor:s.badgeColor,selected:u.has(s.code),onToggle:M},s.code))})]}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-xs font-medium text-secondary-text",children:t("pipeline.start_year_label")}),e.jsx("input",{type:"number",min:2e3,max:2030,value:p,onChange:s=>h(Number(s.target.value)),className:"w-full rounded-md border border-border bg-surface px-3 py-2 text-sm text-foreground"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-xs font-medium text-secondary-text",children:t("pipeline.end_year_label")}),e.jsx("input",{type:"number",min:2e3,max:2030,value:g,onChange:s=>H(Number(s.target.value)),className:"w-full rounded-md border border-border bg-surface px-3 py-2 text-sm text-foreground"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-xs font-medium text-secondary-text",children:t("pipeline.request_delay_label")}),e.jsxs("select",{value:S,onChange:s=>Y(s.target.value),className:"w-full rounded-md border border-border bg-surface px-3 py-2 text-sm text-foreground",children:[e.jsx("option",{value:"0.5",children:t("pipeline.delay_fast")}),e.jsx("option",{value:"1.0",children:t("pipeline.delay_default")}),e.jsx("option",{value:"2.0",children:t("pipeline.delay_safe")}),e.jsx("option",{value:"5.0",children:t("pipeline.delay_very_safe")})]})]})]}),e.jsxs("div",{className:"mt-4 flex items-center gap-3",children:[e.jsxs("button",{onClick:R,disabled:r||i.isPending||u.size===0,className:"flex items-center gap-1 rounded-md bg-accent px-4 py-2 text-sm font-medium text-white hover:bg-accent-light disabled:opacity-50",children:[e.jsx(se,{className:"h-4 w-4"}),t(r?"download.running_status":"pipeline.start")]}),r&&e.jsxs("button",{onClick:()=>i.mutate({action:"stop"}),disabled:i.isPending,className:"flex items-center gap-1 rounded-md border border-danger/30 px-3 py-1.5 text-sm text-danger hover:bg-danger/5",children:[e.jsx(re,{className:"h-4 w-4"})," ",t("pipeline.stop_pipeline")]})]})]})]}),r&&e.jsxs("div",{className:"rounded-lg border border-accent/30 bg-card p-5",children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5 animate-spin text-accent"}),e.jsx("h2",{className:"font-heading text-base font-semibold",children:t("pipeline.live_monitor")})]}),e.jsx("span",{className:"rounded-full bg-accent-muted px-3 py-0.5 text-xs font-medium text-accent",children:D??"Initializing"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted-text",children:[e.jsx("span",{children:t("pipeline.overall_progress")}),e.jsxs("span",{children:[P,"%"]})]}),e.jsx("div",{className:"mt-1 h-2 rounded-full bg-surface",children:e.jsx("div",{className:"h-2 rounded-full bg-accent transition-all duration-500",style:{width:`${Math.min(P,100)}%`}})})]}),n?.phase_progress&&e.jsx("p",{className:"mb-4 text-sm text-muted-text",children:n.phase_progress}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-3",children:T.map(s=>{const a=D===s.id,d=B.includes(s.id),$=s.icon;return e.jsxs("div",{className:`flex items-center gap-3 rounded-md border p-3 ${a?"border-accent bg-accent-muted":d?"border-success/30 bg-success/5":"border-border"}`,children:[d?e.jsx(E,{className:"h-5 w-5 shrink-0 text-success"}):a?e.jsx(F,{className:"h-5 w-5 shrink-0 animate-spin text-accent"}):e.jsx($,{className:"h-5 w-5 shrink-0 text-muted-text"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s.label}),e.jsx("p",{className:"text-xs text-muted-text",children:s.desc})]})]},s.id)})}),o&&e.jsxs("div",{className:"mt-4 grid gap-2 text-xs text-muted-text sm:grid-cols-3",children:[e.jsxs("div",{className:"rounded-md bg-surface p-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Crawl:"})," ",o.crawl.total_found," found,"," ",o.crawl.new_added," new"]}),e.jsxs("div",{className:"rounded-md bg-surface p-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Clean:"})," ",o.clean.dupes_removed," dupes,"," ",o.clean.validated," valid"]}),e.jsxs("div",{className:"rounded-md bg-surface p-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Download:"})," ",o.download.downloaded," ok,"," ",o.download.failed," fail"]})]})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-card",children:[e.jsxs("button",{onClick:()=>L(!v),className:"flex w-full items-center justify-between p-4",children:[e.jsx("h2",{className:"font-heading text-lg font-semibold",children:t("pipeline.pipeline_logs",{count:C.length})}),e.jsx("span",{className:"text-sm text-muted-text",children:t(v?"common.collapse":"common.expand")})]}),v&&e.jsx("div",{className:"max-h-80 overflow-auto border-t border-border bg-surface p-4",children:C.length===0?e.jsx("p",{className:"text-sm text-muted-text",children:t("pipeline.no_logs_yet")}):e.jsx("div",{className:"space-y-1",children:[...C].reverse().slice(0,50).map((s,a)=>e.jsxs("div",{className:"flex gap-2 text-xs",children:[e.jsx("span",{className:"shrink-0 font-mono text-muted-text",children:s.timestamp?.slice(11)??""}),e.jsxs("span",{className:`shrink-0 font-medium ${s.level==="error"?"text-danger":s.level==="warning"?"text-warning":"text-foreground"}`,children:["[",s.phase,"]"]}),e.jsx("span",{className:"text-foreground",children:s.message})]},a))})})]}),y.length>0&&e.jsxs("div",{className:"rounded-lg border border-danger/30 bg-card p-4",children:[e.jsxs("h3",{className:"mb-2 flex items-center gap-2 text-sm font-medium text-danger",children:[e.jsx(W,{className:"h-4 w-4"})," ",t("pipeline.pipeline_errors")," ","(",y.length,")"]}),e.jsx("div",{className:"max-h-40 space-y-1 overflow-auto",children:y.map((s,a)=>e.jsx("p",{className:"text-xs text-danger",children:s},a))})]}),!r&&e.jsxs("div",{className:"rounded-lg border border-border bg-card p-5",children:[e.jsx("h2",{className:"mb-3 font-heading text-base font-semibold",children:t("pipeline.how_pipeline_works")}),e.jsx("div",{className:"grid gap-3 sm:grid-cols-3",children:T.map((s,a)=>{const d=s.icon;return e.jsxs("div",{className:"rounded-md border border-border-light p-4",children:[e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx("div",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-accent text-xs font-bold text-white",children:a+1}),e.jsx(d,{className:"h-4 w-4 text-accent"})]}),e.jsx("h3",{className:"font-medium text-foreground",children:s.label}),e.jsx("p",{className:"mt-1 text-xs text-muted-text",children:s.desc})]},s.id)})}),e.jsxs("div",{className:"mt-4 flex items-start gap-2 rounded-md bg-info/5 p-3 text-xs text-info",children:[e.jsx(te,{className:"mt-0.5 h-3.5 w-3.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{children:"The pipeline runs all three phases automatically with smart fallback strategies."}),e.jsx("p",{className:"mt-1",children:"If a crawl strategy fails, it rotates to the next one (direct → viewdb → keyword search)."})]})]})]})]})}export{ye as PipelinePage};
